
# 第3周概览：多版本并发控制

在这一部分，你将在前两周构建的LSM引擎基础上实现MVCC（多版本并发控制）。我们将通过在键中添加时间戳编码来维护一个键的多个版本，并更改引擎的某些部分，以确保根据是否有用户在读取旧版本，旧数据要么被保留，要么被垃圾回收。

本教程中MVCC部分的一般方法受到[BadgerDB](https://github.com/dgraph-io/badger)的启发，并部分基于其设计。

MVCC的关键在于在存储引擎中存储和访问一个键的多个版本。因此，我们需要将键格式更改为`用户键 + 时间戳（u64）`。在用户接口方面，我们需要提供新的API，帮助用户访问历史版本。总之，我们将为键添加一个单调递增的时间戳。

在前面的部分中，我们假设较新的键位于LSM树的较高层，而较旧的键位于较低层。在压缩过程中，如果在多个层级中发现多个版本，我们只保留最新版本的键，并且压缩过程将确保较新的键通过仅合并相邻层级/层保持在上层。在MVCC实现中，具有较大时间戳的键是最新键。在压缩过程中，如果没有任何用户正在访问数据库的旧版本，我们可以移除该键。尽管在较高层不保留最新版本的键对于MVCC LSM实现仍然可以产生正确的结果，但在我们的教程中，我们选择保持不变性，如果有多个版本的键，较新的版本将始终出现在较高层。

通常，有两种利用支持MVCC的存储引擎的方式。如果用户将引擎作为独立组件使用，并且不想手动分配键的时间戳，他们将使用事务API从存储引擎存储和检索数据。时间戳对用户是透明的。另一种方式是将存储引擎集成到系统中，用户自行管理时间戳。为了比较这两种方法，我们可以看看它们提供的API。我们使用BadgerDB的术语来描述这两种用法：隐藏时间戳的是*非托管模式*，而给用户完全控制的是*托管模式*。

**托管模式API**
```
get(key, read_timestamp) -> (value, write_timestamp)
scan(key_range, read_timestamp) -> iterator
put/delete/write_batch(key, timestamp)
set_watermark(timestamp) # 我们很快会谈到水印！
```

**非托管/普通模式API**
```
get(key) -> value
scan(key_range) -> iterator
start_transaction() -> txn
txn.put/delete/write_batch(key, timestamp)
```

如你所见，托管模式API要求用户在进行操作时提供时间戳。时间戳可能来自某些集中式时间戳系统，或其他系统的日志（例如，Postgres逻辑复制日志）。用户需要指定一个水印，这是引擎可以移除的版本以下的版本。

对于非托管API，它与我们之前实现的内容相同，除了用户需要通过创建事务来写入和读取数据。当用户创建一个事务时，他们可以获得数据库的一致状态（即快照）。即使其他线程/事务向数据库写入数据，这些数据对于正在进行的事务也是不可见的。存储引擎在内部管理时间戳，并不向用户暴露。

在这一周，我们将首先花3天时间对表格式和内存表进行重构。我们将把键格式更改为键切片和时间戳。之后，我们将实现必要的API，以提供一致的快照和事务。

这一部分有7章（天）：

* [第1天：时间戳键重构](./week3-01-ts-key-refactor.md)。你将把`key`模块更改为MVCC版本，并重构你的系统以使用带时间戳的键。
* [第2天：快照读取 - 内存表和时间戳](./week3-02-snapshot-read-part-1.md)。你将重构内存表和写路径，以支持多版本读取/写入。
* [第3天：快照读取 - 事务API](./week3-03-snapshot-read-part-2.md)。你将实现事务API，并完成读取/写入路径的其余部分，以支持快照读取。
* [第4天：水印和垃圾回收](./week3-04-watermark.md)。你将实现水印计算算法，并在压缩时实现垃圾回收，以移除旧版本。
* [第5天：事务和乐观并发控制](./week3-05-txn-occ.md)。你将为所有事务创建私有工作空间，并批量提交它们，以便事务的修改对其他事务不可见。
* [第6天：可序列化快照隔离](./week3-06-serializable.md)。你将实现OCC可序列化检查，以确保对数据库的修改是可序列化的，并中止违反可序列化性的事务。
* [第7天：压缩过滤器](./week3-07-compaction-filter.md)。在本周结束时，我们将把压缩时垃圾回收逻辑泛化为压缩过滤器，根据用户需求在压缩时移除数据。

{{#include copyright.md}}
